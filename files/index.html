<!DOCTYPE html>
<!-- saved from url=(0050)http://getbootstrap.com/examples/starter-template/ -->
<html  xmlns="http://www.w3.org/1999/xhtml" 
xmlns:og="http://ogp.me/ns#" 
xmlns:fb="http://www.facebook.com/2008/fbml">
<head>
	<!-- meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta property="og:description" content="" />
	<meta property="og:title" content="U-Traffic"/>
	<meta property="og:url" content="http://114.35.45.209:3000/demo"/>
	<meta property="og:image" content="http://114.35.45.209:3000/img/useful.png"/>
	<meta property="og:site_name" content="U-Traffic" />
	
    <title>U-Traffic</title>

	<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAjU0EJWnWPMv7oQ-jjS7dYxSPW5CJgpdgO_s4yyMovOaVh_KvvhSfpvagV18eOyDWu7VytS6Bi1CWxw"
      type="text/javascript"></script>

  	<script type="text/javascript">
	var auto_lat=0;
	var auto_lon=0;
	var map = null;
    var geocoder = null;
	var domain="http://localhost:8080/";
	
	navigator.geolocation.getCurrentPosition(function (pos) {
	    auto_lat = pos.coords.latitude;  //取得經度
	    auto_lon = pos.coords.longitude; //取得緯度
	});
	
	/*
	function initialize() {
	navigator.geolocation.getCurrentPosition();
	   var mapOptions = {
			zoom: 6,
			center: new google.maps.LatLng(auto_lat, auto_lon),
			mapTypeId: google.maps.MapTypeId.ROADMAP
		  };

		map = new google.maps.Map(document.getElementById('genGMDiv'), mapOptions);
		map.setCenter(new google.maps.LatLng(auto_lat, auto_lon));
		
		
		form1.sumbmit();
	}
	*/

  	
  	$(document).ready(function() {
		//alert(auto_lat);
		//alert(auto_lon);

		//google.maps.event.addDomListener(window, 'load', initialize);

		//http://www.oulan.com/w/?ZRPEyU2f
		//http://maps.google.com/maps?q=loc:25.074020,121.654129
		var gmURL="http://maps.google.com/maps?q=loc:"+auto_lat+","+auto_lon
		//http://maps.google.com.tw/maps?f=q&hl=zh-TW&geocode=&q=輸入查詢的地址&z=比例大小&output=embed&t=地圖模式
		//$('#genGMDiv').html("<iframe width='800' height='600' frameborder='0' scrolling='no' marginheight='0' marginwidth='0' src="+gmURL+"></iframe>");
		//$('#genGMDiv').find('iframe').attr('src','http://maps.google.com/maps?q=loc:25.074020,121.654129');
		
		
		
		
		
		
		//<iframe width="800" height="600" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src=http://maps.google.com.tw/maps?f=q&hl=zh-TW&geocode=&q=臺北市羅斯福路二段102號&z=16&output=embed&t=></iframe>
		
	});
	function getPositionScore(lat,lon){
	
		$.ajax({
				type : 'POST',
				url : domain+"useful/api/v1/traffic/audit/position",
				data : {
					lon:lon,
					lat:lat
				},
				dataType : 'json',
				async : true,
				success : function(jsonData) {
					//alert("交通便利指數:"+Math.round(jsonData.score)) ;
					
					$('#trafficScore').html("交通便利指數:"+Math.round(jsonData.score))
				}
		});
	
	
	}

	
	function getAddressScore(address){
	
		$.ajax({
				type : 'POST',
				url : domain+"useful/api/v1/traffic/audit/address",
				data : {
					address:address
				},
				dataType : 'json',
				async : true,
				success : function(jsonData) {
					//alert("交通便利指數:"+Math.round(jsonData.score)) ;
					
					$('#trafficScore').html("交通便利指數:"+Math.round(jsonData.score))
				}
		});
	
	}
	function getStatisticsViaPosition(lat,lon){
	
		$.ajax({
				type : 'POST',
				url : domain+"useful/api/v1/traffic/statistics/position",
				data : {
					lon:lon,
					lat:lat
				},
				dataType : 'json',
				async : true,
				success : function(jsonData) {
					
					$('#statisticsReport').html("");
					
					$.each(jsonData, function(index, element) {
						$('#statisticsReport').append($('<div>', {
							text: index
						})).append($('<div>', {
							text: "火車站:"+element.train
						})).append($('<div>', {
							text: "客運站:"+element.shuttle
						})).append($('<div>', {
							text: "停車場:"+element.parking_lot
						})).append($('<div>', {
							text: "機場:"+element.airport
						})).append($('<div>', {
							text: "捷運站(含出口):"+element.MRT
						})).append($('<div>', {
							text: "高鐵站:"+element.THSR
						})).append($('<div>', {
							text: "高快速公路(含交流道):"+element.highway
						})).append($('<div>', {
							text: "公車站牌:"+element.bus
						})).append($('<div>', {
							text: "公共自行車租借處:"+element.bike
						}));
						
					});
					
					
				}
		});

	}
	function getStatisticsViaAddress(address){
	
		$.ajax({
				type : 'POST',
				url : domain+"useful/api/v1/traffic/statistics/address",
				data : {
					address:address
				},
				dataType : 'json',
				async : true,
				success : function(jsonData) {
					$('#statisticsReport').html("");
					
					$.each(jsonData, function(index, element) {
						$('#statisticsReport').append($('<div>', {
							text: index
						})).append($('<div>', {
							text: "火車站:"+element.train
						})).append($('<div>', {
							text: "客運站:"+element.shuttle
						})).append($('<div>', {
							text: "停車場:"+element.parking_lot
						})).append($('<div>', {
							text: "機場:"+element.airport
						})).append($('<div>', {
							text: "捷運站(含出口):"+element.MRT
						})).append($('<div>', {
							text: "高鐵站:"+element.THSR
						})).append($('<div>', {
							text: "高快速公路(含交流道):"+element.highway
						})).append($('<div>', {
							text: "公車站牌:"+element.bus
						})).append($('<div>', {
							text: "公共自行車租借處:"+element.bike
						}));
						
					});
				}
		});

	}
	
	
	function initialize() {
      if (GBrowserIsCompatible()) {
	  /*
		var mapOptions = {
			zoom: 6,
			center: new google.maps.LatLng(auto_lat, auto_lon),
			mapTypeId: google.maps.MapTypeId.ROADMAP
		  };
	  */
		navigator.geolocation.getCurrentPosition(function (pos) {
			auto_lat = pos.coords.latitude;  //取得經度
			auto_lon = pos.coords.longitude; //取得緯度
			
			//alert(auto_lat);
			
			map = new GMap2(document.getElementById("map_canvas"));
			map.setCenter(new GLatLng(auto_lat, auto_lon), 18);
			map.setUIToDefault();
			geocoder = new GClientGeocoder();
			//geocoder = google.maps.Geocoder();//new GClientGeocoder();
			$('input[name=address]').val(auto_lat+" , "+auto_lon);
			$('#form1').submit();
		});
		
			map = new GMap2(document.getElementById("map_canvas"));
			map.setCenter(new GLatLng(auto_lat, auto_lon), 1);
			map.setUIToDefault();
			geocoder = new GClientGeocoder();
			//geocoder = google.maps.Geocoder();//new GClientGeocoder();
		
	  
      }
    }
	

    function showAddress(address) {
	
	  //var result = address.split(',');
	  //alert(result.length);
	 
	  
      if (geocoder) {
        geocoder.getLatLng(
          address,
          function(point) {
            if (!point) {
              alert(address + " not found");
            } else {
			
				
              map.setCenter(point, 15);
              var marker = new GMarker(point, {draggable: true});
              map.addOverlay(marker);
              GEvent.addListener(marker, "dragend", function() {
				var latLngStr=marker.getLatLng().toUrlValue(6);
				result = latLngStr.split(',');
				//alert(marker.getLatLng().toUrlValue(6));
                marker.openInfoWindowHtml(marker.getLatLng().toUrlValue(6));
				if(result.length==2)//地址
				{
					getPositionScore(result[0],result[1]);
					getStatisticsViaPosition(result[0],result[1]);
				}
				else
				{
					getAddressScore(address);
					getStatisticsViaAddress(address);
				}
              });
              GEvent.addListener(marker, "click", function() {
				var latLngStr=marker.getLatLng().toUrlValue(6);
				result = address.split(',');
				//alert(result[0]);
				//alert(result[1]);
				//alert(result.length);
                marker.openInfoWindowHtml(marker.getLatLng().toUrlValue(6));
				if(result.length==2)//地址
				{
					getPositionScore(result[0],result[1]);
					getStatisticsViaPosition(result[0],result[1]);
				}
				else
				{
					getAddressScore(address);
					getStatisticsViaAddress(address);
				}
				
              });
			  GEvent.trigger(marker, "click");
            }
          }
        );
      }
    }
	</script>
	
	
</head>

	<body onload="initialize()" onunload="GUnload()">
		<form id='form1' action="#" onsubmit="showAddress(this.address.value); return false">
		  <p>
			
			<br/>
			
		  </p>
		  <p>
			<input type="text" style="width:350px" name="address" value="請輸入..." />
			<input type="submit" value="Search" />
		  </p>
		  <table>
			<tr>
				<td>
					<div id="map_canvas" style="width: 800px; height: 600px"></div>
				</td>
				<td style='width:100px'></td>
				<td>
					<div id='trafficScore'></div>
					<div id='statisticsReport'></div>
				</td>
			</tr>
		  </table>
		 
		  
		  
		</form>

	</body>
</html>